<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/gif" href="image.png">
  <title>leaperChatGun – Device ID Rooms</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Minimal custom CSS - using style.css for most styles */
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }

    .chat-header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .grow {
      flex: 1 1 240px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 12px;
      color: var(--text-light);
      opacity: 0.8;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Chat area */
    .chat {
      height: min(60vh, 560px);
      overflow: auto;
      padding: 1rem;
      scroll-behavior: smooth;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .msg {
      max-width: 86%;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.1);
    }

    .me {
      background: linear-gradient(135deg, var(--color1), var(--color2));
      margin-left: auto;
      border-top-right-radius: 6px;
      color: var(--color5);
    }

    .them {
      background: rgba(255, 255, 255, 0.15);
      border-top-left-radius: 6px;
    }

    .meta {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
    }

    .inputbar {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .inputbar textarea {
      height: 54px;
      resize: vertical;
      min-height: 48px;
      max-height: 160px;
    }

    .send {
      flex: 0 0 120px;
    }

    .foot {
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }

    .warn {
      color: #ff7043;
    }

    .green {
      color: var(--color1);
    }

    .link {
      color: var(--color1);
      text-decoration: underline;
      cursor: pointer;
    }

    .small {
      font-size: 12px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 14px;
      right: 14px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      z-index: 1000;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .inputbar {
        flex-direction: column;
      }
      
      .send {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-brand">leaperStuff</a>
      <ul class="navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="tools.html">Tools</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">
    <!-- Header -->
    <div class="chat-header">
      <h1 style="color: var(--color1); margin: 0;">leaperChatGun <span class="badge badge-primary">client‑only</span></h1>
      <div class="pill">Device ID: <span id="deviceId" class="mono"></span></div>
    </div>

    <!-- Room Configuration -->
    <section class="card">
      <div class="row">
        <div class="grow">
          <label class="form-label">Chat ID (share with your friend)</label>
          <input id="room" class="form-control mono" placeholder="e.g. yellow-tiger-8291" />
        </div>
        <div class="grow">
          <label class="form-label">Secret (optional – encrypts messages)</label>
          <input id="secret" type="password" class="form-control" placeholder="passphrase for E2E encryption" />
        </div>
      </div>
      <div class="toolbar">
        <button id="join" class="btn btn-primary">Join / Create Room</button>
        <button id="copyLink" class="btn btn-secondary">Copy Invite Link</button>
        <span class="pill">Relay peers: <span id="peerStatus" class="mono">—</span></span>
      </div>
      <div class="foot small">
        No accounts. Messages sync via public <a class="link" target="_blank" href="https://github.com/amark/gun">GUN</a> relays. 
        Use a <b>Secret</b> you share out‑of‑band for end‑to‑end encryption. Don't put private data here without a secret. 
        Made by Ivaan Srivastava AKA leaperStuff.
      </div>
    </section>

    <!-- Chat Interface -->
    <section class="card" style="padding: 0;">
      <div id="chat" class="chat"></div>
      <div style="padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div class="inputbar">
          <textarea id="text" class="form-control" placeholder="Type a message…"></textarea>
          <button id="send" class="btn btn-primary send">Send</button>
        </div>
        <div class="foot">
          <span id="roomHint"></span>
          <span id="encHint" class="green"></span>
        </div>
      </div>
    </section>

    <p class="foot">Tip: Share the invite link. Your friend opens it, enters the same Secret (if used), and you can chat. Messages persist on community relays unless cleared.</p>
  </div>

  <!-- GUN (peer-to-peer-ish DB) and SEA (crypto) -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/axe.js"></script>

  <script>
    // Your existing JavaScript remains exactly the same
    const $ = (id)=>document.getElementById(id);

    function getDeviceId(){
      let id = localStorage.getItem('deviceId');
      if(!id){ id = crypto.randomUUID(); localStorage.setItem('deviceId', id); }
      return id;
    }

    function randomRoom(){
      const animals = ['tiger','otter','panda','eagle','whale','koala','lynx','yak','zebra','gecko','sloth','ibis'];
      const colors  = ['yellow','gold','amber','sun','lemon','honey'];
      return `${colors[Math.floor(Math.random()*colors.length)]}-${animals[Math.floor(Math.random()*animals.length)]}-${Math.floor(1000+Math.random()*8999)}`;
    }

    const deviceId = getDeviceId();
    $('deviceId').textContent = deviceId.slice(0,8);

    const peers = [
      'https://relay.peer.ooo/gun',
      'https://gun-manhattan.herokuapp.com/gun',
      'https://gunjs.herokuapp.com/gun'
    ];

    const gun = Gun({ peers, retry: 2500 });

    let connectedPeers = new Set();
    gun.on('hi', peer => { connectedPeers.add(peer.url); updatePeerStatus(); });
    gun.on('bye', peer => { connectedPeers.delete(peer.url); updatePeerStatus(); });
    function updatePeerStatus(){
      $('peerStatus').textContent = `${connectedPeers.size}/${peers.length} connected`;
    }

    let roomId = '';
    let secret = '';
    let roomNode = null;
    const seen = new Set();

    function initFromHash(){
      const h = decodeURIComponent(location.hash.replace(/^#/,'')).trim();
      if(h){ $('room').value = h; }
      if(!$('room').value) $('room').value = randomRoom();
      $('roomHint').textContent = '';
    }

    initFromHash();

    function setEncHint(){
      if(secret) $('encHint').textContent = 'Encryption: ON (shared secret)';
      else $('encHint').textContent = 'Encryption: OFF (use a Secret to enable)';
    }

    setEncHint();

    $('secret').addEventListener('input', ()=>{ secret = $('secret').value; setEncHint(); });

    $('copyLink').onclick = async ()=>{
      const id = $('room').value.trim();
      const url = location.origin + location.pathname + '#' + encodeURIComponent(id);
      await navigator.clipboard.writeText(url);
      toast(`Invite link copied`);
    };

    $('join').onclick = async ()=>{
      joinRoom($('room').value.trim());
    };

    function toast(msg){
      const div = document.createElement('div');
      div.textContent = msg;
      div.className = 'toast';
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),1600);
    }

    async function enc(plain){
      if(!secret) return plain;
      try{ return await SEA.encrypt(plain, secret); }catch(e){ console.error(e); return plain; }
    }
    async function dec(cipher){
      if(!secret) return cipher;
      try{ return await SEA.decrypt(cipher, secret); }catch(e){ return '[Unable to decrypt – wrong secret?]'; }
    }

    function joinRoom(id){
      if(!id){ toast('Enter a Chat ID'); return; }
      if(roomNode){ roomNode.off(); }
      roomId = id;
      location.hash = encodeURIComponent(roomId);
      $('roomHint').textContent = `Room: ${roomId}`;
      $('chat').innerHTML = '';
      seen.clear();

      roomNode = gun.get('rooms').get(roomId);

      roomNode.get('messages').map().on(async (msg, key)=>{
        if(!msg) return;
        const uid = msg.uid || key;
        if(seen.has(uid)) return; seen.add(uid);

        const text = await dec(msg.text);
        renderMsg({
          me: msg.from === deviceId,
          text: String(text || ''),
          ts: msg.ts || Date.now(),
          from: msg.from
        });
      });

      toast('Joined room');
    }

    function renderMsg({me,text,ts,from}){
      const box = document.createElement('div');
      box.className = 'msg ' + (me? 'me':'them');
      box.innerHTML = `<div>${escapeHtml(text)}</div><div class="meta">${new Date(ts).toLocaleString()} • ${me? 'you': 'id '+(from||'–').slice(0,8)}</div>`;
      $('chat').appendChild(box);
      $('chat').scrollTop = $('chat').scrollHeight;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    $('send').onclick = async ()=>{
      const t = $('text').value.trim();
      if(!t) return;
      if(!roomId){ toast('Join a room first'); return; }
      const uid = crypto.randomUUID();
      const payload = {
        uid,
        from: deviceId,
        ts: Date.now(),
        text: await enc(t)
      };
      seen.add(uid);
      renderMsg({me:true,text:t,ts:payload.ts,from:deviceId});
      $('text').value='';
      roomNode.get('messages').set(payload);
    };

    $('text').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('send').click(); }
    });

    window.addEventListener('load', ()=>{
      secret = $('secret').value; setEncHint();
      joinRoom($('room').value.trim());
    });
  </script>
</body>
</html>